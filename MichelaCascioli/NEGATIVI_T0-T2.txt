WITH attuale
     AS (
     SELECT ragsoc,
            codpsi,
            MAX(m.Agente) Agente,
            Area,
            SUM(Importo) Impo,
            SUM(Consegnato) Cons
     FROM
     (
         SELECT [archivio],
                ult.[id],
                a.ragsoc,
                ult.[Codice],
                [comweb],
                [Piva],
                [Firmante],
                ang.nome Agente,
                [Qualifica],
                [CodFiscale],
                ult.[Gruppo],
      --,[Agente] 
                [Riferimento],
                [CodPsi],
                [Luogo],
                [DataComm_Annoprec],
                [DataComm],
                [Commissione],
                [Anno],
                [DataPrRata],
                [Rate],
                [Cadenza],
                [Acconto],
                [Consegnato],
                [ModConsegnato],
                [Importo],
                [aliqIva],
                [Causale],
                [BancAbi],
                [BancCab],
                [ContoCor],
                [IntFat],
                [IntCoDes],
                [IntCoInd],
                [IntCoCap],
                [IntCoLoc],
                [Modificato],
                [Visitato],
                [ModPagam],
                [Contabil],
                [StampaFat],
                [DataFat],
                [CrystalFat],
                [Biann],
                [BiannI],
                [BiannA],
                [RinTac],
      --,[Annotaz] 
                [TipoCli],
                [NcImpo],
                [NcNum],
                [NcData],
                [AutRidSped],
                [AutRidRic],
                [Lng1],
                [Lng2],
                [WarnIns],
                [Validaz],
                [Grafico],
                [InAgenzia],
                [Attesa],
                [MotivoAtt],
                [DataLavoraz],
                [SpedBozza],
                [DataModif],
                [NoteStorico],
                [StornoRid],
                [DataProv],
                [Impo2],
                [CrdStato],
                [CrdScade],
                [ExGruppo],
                [ExAgente],
                [Diciture],
                [Area],
                [Azienda],
                [Prezzo],
                [PraticaErr],
                [regdom],
                [NoSpInc],
                [GruppoR],
                [AgenteR],
                [Iban],
                [daVer],
                [fatbloc],
                [comBgl],
                [comTus],
                [GruppoTus],
                [AgenteTus],
                [ncbloc],
                [dataCrt],
                [oraCrt],
                [pcCrt],
                [opCrt],
                [bgldata],
                [negativo],
                [DataAccet],
                [DataRegDom],
                [ModalAccet],
                [CauDinRid],
                [AnnotGraf],
                [dataCaric],
                [importoWeb],
                [ggScadRt],
                [dataScadRt],
                [dataAccetPrec],
                [dittaIndiv],
                [codPremio],
                [sottoTar],
                [ageRiassIniCamp],
                [exRinTac],
                [stContr],
                [dataCampagna],
                [chkScad],
                [prodConc],
                [oggPostic],
                [exConsegnato],
                [autfattinv],
                [autfattric],
                [mailWelcome],
                [fatpa],
                [ridfirst],
                [annsostid],
                [competenzaDa],
                [competenzaA],
                [dataPrecaricamento],
                [ImpoAnnullato],
                [socRecupero],
                [nuovoiban],
                [exPluriennale],
                [dataVers],
                [exOmaggio],
                [dataAffid],
                [tariffaMensile],
                [fattAutom],
                [propPrio],
                [verChius],
                [tipoSocieta],
                [inAttesaRiass],
                [daSanareProd],
                [importoInsoluto],
                [importoScaduto],
                [campagnaDa],
                [campagnaA]
         FROM [estrazioni].[dbo].[vCommissioniUltimeCampagne] ult
              LEFT JOIN anagraf.dbo.anagrafica a ON a.codice = ult.codice
              LEFT JOIN anagraf.dbo.agenti ag ON ag.gruppo = ult.gruppo
                                                 AND ag.codagente = ult.Agente
              LEFT JOIN anagraf.dbo.anage ang ON ang.utente = ag.utente
         WHERE area IN('RM', 'RW')
              --AND (importo IS NULL
              --     AND consegnato IS NULL)
     ) m
     GROUP BY ragsoc,
              codpsi,
--m.Agente,
              area),
     terzult
     AS (
     SELECT ragsoc,
            codpsi,
            MAX(m.Agente) Agente,
            area,
            SUM(importo) ImpoTOT
     FROM
     (
         SELECT [archivio],
                RagSoc,
                ter.[id],
                ter.[Codice],
                [comweb],
                [Piva],
                [Firmante],
                [Qualifica],
                [CodFiscale],
                ter.[Gruppo],
      --,[Agente] 
                ang.nome Agente,
                [Riferimento],
                [CodPsi],
                [Luogo],
                [DataComm_Annoprec],
                [DataComm],
                [Commissione],
                [Anno],
                [DataPrRata],
                [Rate],
                [Cadenza],
                [Acconto],
                [Consegnato],
                [ModConsegnato],
                [Importo],
                [aliqIva],
                [Causale],
                [BancAbi],
                [BancCab],
                [ContoCor],
                [IntFat],
                [IntCoDes],
                [IntCoInd],
                [IntCoCap],
                [IntCoLoc],
                [Modificato],
                [Visitato],
                [ModPagam],
                [Contabil],
                [StampaFat],
                [DataFat],
                [CrystalFat],
                [Biann],
                [BiannI],
                [BiannA],
                [RinTac],
      --,[Annotaz] 
                [TipoCli],
                [NcImpo],
                [NcNum],
                [NcData],
                [AutRidSped],
                [AutRidRic],
                [Lng1],
                [Lng2],
                [WarnIns],
                [Validaz],
                [Grafico],
                [InAgenzia],
                [Attesa],
                [MotivoAtt],
                [DataLavoraz],
                [SpedBozza],
                [DataModif],
                [NoteStorico],
                [StornoRid],
                [DataProv],
                [Impo2],
                [CrdStato],
                [CrdScade],
                [ExGruppo],
                [ExAgente],
                [Diciture],
                [Area],
                [Azienda],
                [Prezzo],
                [PraticaErr],
                [regdom],
                [NoSpInc],
                [GruppoR],
                [AgenteR],
                [Iban],
                [daVer],
                [fatbloc],
                [comBgl],
                [comTus],
                [GruppoTus],
                [AgenteTus],
                [ncbloc],
                [dataCrt],
                [oraCrt],
                [pcCrt],
                [opCrt],
                [bgldata],
                [negativo],
                [DataAccet],
                [DataRegDom],
                [ModalAccet],
                [CauDinRid],
                [AnnotGraf],
                [dataCaric],
                [importoWeb],
                [ggScadRt],
                [dataScadRt],
                [dataAccetPrec],
                [dittaIndiv],
                [codPremio],
                [sottoTar],
                [ageRiassIniCamp],
                [exRinTac],
                [stContr],
                [dataCampagna],
                [chkScad],
                [prodConc],
                [oggPostic],
                [exConsegnato],
                [autfattinv],
                [autfattric],
                [mailWelcome],
                [fatpa],
                [ridfirst],
                [annsostid],
                [competenzaDa],
                [competenzaA],
                [dataPrecaricamento],
                [ImpoAnnullato],
                [socRecupero],
                [nuovoiban],
                [exPluriennale],
                [dataVers],
                [exOmaggio],
                [dataAffid],
                [tariffaMensile],
                [fattAutom],
                [propPrio],
                [verChius],
                [tipoSocieta],
                [inAttesaRiass],
                [daSanareProd],
                [importoInsoluto],
                [importoScaduto],
                [campagnaDa],
                [campagnaA]
         FROM [estrazioni].[dbo].[vCommissioniTerzultimeCampagne] ter
              LEFT JOIN anagraf.dbo.anagrafica a ON a.codice = ter.codice
              LEFT JOIN anagraf.dbo.agenti ag ON ag.gruppo = ter.gruppo
                                                 AND ag.codagente = ter.Agente
              LEFT JOIN anagraf.dbo.anage ang ON ang.utente = ag.utente
         WHERE area IN('RM', 'RW')
              AND (importo <> 0)
     ) m
     GROUP BY ragsoc,
              codpsi,
--m.Agente,
              area)
     SELECT DISTINCT
            attuale.ragsoc RagSoc,
            attuale.codpsi CodPsi,
            attuale.Agente,
            attuale.area Area,
            attuale.Impo ImpoT2,
            attuale.Cons ConsT2,
            terzult.ImpoToT ImpoT0
     FROM attuale
          INNER JOIN terzult ON attuale.codpsi = terzult.codpsi
                                AND attuale.area = terzult.area
     WHERE(attuale.Impo IS NULL
           AND attuale.Cons IS NULL)
     ORDER BY attuale.ragsoc;