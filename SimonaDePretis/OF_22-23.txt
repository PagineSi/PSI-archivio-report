
/****** Script per comando SelectTopNRows da SSMS  ******/

SELECT DISTINCT
       m.Codpsi,
       m.RagSoc,
       m.Area,
       m.Categoria,
       SUM(m.consegnato) Consegnato,
       SUM(m.tot_acquisito) Acquisito,
       --SUM(m.importoInsoluto) Insoluto,
       --CONVERT(DATE, MAX(m.DataComm)) DataComm,
       MAX(format(m.datacompetenza, 'yyyy-MM-dd')) DataCompetenza
FROM
(
    SELECT [archivio],
           [nomeArchivio],
           a.ragsoc,
           cat.categoria,
           [idCom],
           [CodPsi],
           [consegnato],
           [tot_acquisito],
           [CodiceAnagrafica],
           [Commissione],
           [DataCommString],
           [DataComm],
           [DataCompetenza],
           [anno],
           [mese],
           [Area],
           [Gruppo],
           [CodAgente],
           [utenteAgente],
           [nomeAgente],
           [BiannI],
           [BiannA],
           [isRinnovoTacito],
           [isPluriennale],
           [StatoContratto],
           [Causale],
           [SAS],
           [annsostid],
           [futuro],
           [aliqIva],
           [ncImpo],
           [DataPrRata],
           [ModPagam],
           [comweb],
           [CrdStato],
           [CrdScade],
           [Rate],
           [Cadenza],
           [socRecupero],
           [DataFat],
           [StampaFat],
           [NoSpInc],
           [campagnaDa],
           [campagnaA],
           [consegnato_presente],
           [tipo_importo],
           [daSanareProd],
           [importoScaduto],
           [importoInsoluto],
           [totale_da_tariffario],
           [totale_da_tariffario_concessione],
           [totale_da_tariffario_property],
           [tot_importo],
           [tot_importo_SAS],
           [tot_importo_firmato],
           [tot_importo_firmato_nuovi],
           [tot_importo_firmato_rinnovi],
           [tot_importo_firmato_SAS],
           [tot_importo_maturato],
           [tot_importo_maturato_SAS],
           [tot_importo_da_maturare],
           [tot_importo_da_maturare_SAS],
           [importo_amministrativo],
           [importo_amministrativo_SAS],
           [importo_amministrativo_firmato],
           [importo_amministrativo_firmato_nuovi],
           [importo_amministrativo_firmato_rinnovi],
           [importo_amministrativo_firmato_SAS],
           [importo_amministrativo_maturato],
           [importo_amministrativo_maturato_SAS],
           [importo_amministrativo_da_maturare],
           [importo_amministrativo_da_maturare_SAS],
           [acquisito_property],
           [acquisito_concessione],
           [acquisito_SAS],
           [tot_firmato],
           [firmato_nuovi],
           [firmato_rinnovi],
           [firmato_property],
           [firmato_concessione],
           [firmato_nuovi_property],
           [firmato_rinnovi_property],
           [firmato_nuovi_concessione],
           [firmato_rinnovi_concessione],
           [firmato_SAS],
           [tot_maturato],
           [maturato_property],
           [maturato_concessione],
           [maturato_SAS],
           [tot_da_maturare],
           [da_maturare_property],
           [da_maturare_concessione],
           [da_maturare_SAS]
    FROM [estrazioni].[dbo].[vAnalisiImportiCommissioni] aic
         LEFT JOIN anagraf.dbo.anagrafica a ON a.codice = aic.CodiceAnagrafica
         LEFT JOIN anagraf.dbo.categorie cat ON cat.codice = a.categoria
    WHERE format(aic.datacompetenza, 'yyyyMMdd') BETWEEN '20230101' AND '20231231'
          AND cat.catref = 393
) m
GROUP BY m.codpsi,
         m.RagSoc,
         m.Area,
         m.Categoria
ORDER BY codpsi;