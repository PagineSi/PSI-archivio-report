SELECT DISTINCT
       c.idcom,
       c.[CodPsi],
	  a.RagSoc,
       format(c.[DataComm], 'yyMMdd') DataComm,
       c.[nomeAgente] Agente,
       (STUFF(
             (
                 SELECT ', '+aio.tipo_inserz
                 FROM estrazioni.dbo.vAnalisiImportiOggetti aio
                      INNER JOIN estrazioni.dbo.vAnalisiImportiCommissioni c1 ON c1.idCom = aio.idCom
                                                                                 AND c1.archivio = aio.archivio
                 WHERE c.archivio = c1.archivio
                       AND c.idcom = c1.idcom
                       AND c1.tipo_importo = 'FIRMATO'
                       AND aio.codice_tipo_inserz IN(1, 2, 17, 18, 19, 20, 21, 22, 23, 26, 27, 28, 30, 31, 32, 280, 281, 283, 284, 285, 286, 287, 288, 289, 290, 291, 292, 293, 294, 295, 296, 297, 298, 299, 302, 323, 325, 327, 330, 332, 333, 336, 337, 360, 365, 367, 368, 369, 370, 371, 372, 373, 377, 378, 379, 382, 384, 403, 406, 410, 412, 413, 414, 415, 416, 434, 446, 451, 488, 514, 552, 560, 561, 562, 563, 564, 565, 655, 673, 674, 675, 676, 726, 728, 744, 821, 885, 886, 887, 918, 919, 930, 931, 932, 934, 935, 936, 937, 966, 975, 976, 977, 978, 979, 980, 981, 982, 983, 984, 985, 986, 997, 1006, 1007, 1009, 1013, 1015, 1018, 1019, 1020, 1021, 1022, 1023, 1024, 1025, 1026, 1027, 1028, 1029, 1030, 1031, 1032, 1033, 1035, 1036, 1037, 1038, 1039, 1041, 1042, 1044, 1045, 1046, 1047, 1048, 1055, 1056, 1057, 1058, 1059, 1060, 1061, 1062, 1069, 1070, 1077, 1078, 1079, 1081, 1149, 1150, 1151, 1152, 1153, 1154, 1155, 1157, 1158, 1159, 1160, 1162, 1163, 1164, 1219, 1220, 1221, 1222, 1234, 1235, 1236, 1238, 1254, 1255, 1257, 1312, 1313, 1314, 1324, 1347, 1357, 1358, 1369, 1370, 1371, 1372, 1373, 1374, 1375, 1376, 1377, 1378, 1379, 1380, 1395, 1396, 1398, 1399, 1400, 1430, 1431, 1432, 1433, 1446, 1447, 1448, 1452, 1475, 1476, 1493, 1515, 1516, 1521, 1522, 1523, 1527, 1528, 1529, 1563, 1602, 1606, 1610, 1621, 1622, 1624, 1625, 1626, 1627, 1628, 1629, 1630, 1631, 1684, 1685, 1686, 1688, 1690, 1691, 1692, 1699, 1700, 1704, 1705, 1706, 1707, 1727, 1728, 1747, 1748, 1749, 1750, 1751, 1755, 1756, 1757, 1758, 1787, 1788, 1789, 1802, 16, 29, 47, 48, 49, 63, 252, 253, 254, 255, 256, 257, 282, 310, 311, 312, 324, 338, 341, 359, 362, 374, 375, 376, 380, 381, 383, 391, 392, 393, 394, 395, 398, 399, 400, 402, 404, 405, 408, 411, 418, 419, 421, 436, 437, 439, 441, 442, 444, 445, 448, 515, 550, 683, 727, 729, 739, 753, 754, 755, 756, 757, 758, 759, 760, 761, 762, 763, 764, 765, 766, 767, 768, 769, 770, 771, 772, 773, 774, 775, 778, 779, 780, 781, 782, 783, 784, 785, 786, 787, 788, 789, 790, 791, 792, 793, 794, 795, 796, 797, 798, 799, 800, 801, 814, 817, 839, 840, 848, 877, 888, 889, 920, 929, 943, 988, 989, 990, 991, 992, 993, 1005, 1011, 1012, 1043, 1049, 1050, 1051, 1052, 1053, 1054, 1080, 1111, 1112, 1237, 1310, 1311, 1402, 1453, 1580, 1583, 1584, 1585, 1586, 1587, 1588, 1589, 1701, 1702, 1703) FOR XML PATH('')
             ), 1, 2, '')) AS Sigle
FROM [estrazioni].[dbo].[vAnalisiImportiCommissioni] c
     INNER JOIN estrazioni.dbo.vanalisiImportioggetti o ON o.idcom = c.idCom
                                                           AND c.archivio = o.archivio
     LEFT JOIN anagraf.dbo.Anagrafica a on a.codice=c.CodiceAnagrafica
WHERE c.tipo_importo = 'FIRMATO'
      AND c.DataComm BETWEEN '20210101' AND '20220101'
      AND o.codice_tipo_inserz IN(1, 2, 17, 18, 19, 20, 21, 22, 23, 26, 27, 28, 30, 31, 32, 280, 281, 283, 284, 285, 286, 287, 288, 289, 290, 291, 292, 293, 294, 295, 296, 297, 298, 299, 302, 323, 325, 327, 330, 332, 333, 336, 337, 360, 365, 367, 368, 369, 370, 371, 372, 373, 377, 378, 379, 382, 384, 403, 406, 410, 412, 413, 414, 415, 416, 434, 446, 451, 488, 514, 552, 560, 561, 562, 563, 564, 565, 655, 673, 674, 675, 676, 726, 728, 744, 821, 885, 886, 887, 918, 919, 930, 931, 932, 934, 935, 936, 937, 966, 975, 976, 977, 978, 979, 980, 981, 982, 983, 984, 985, 986, 997, 1006, 1007, 1009, 1013, 1015, 1018, 1019, 1020, 1021, 1022, 1023, 1024, 1025, 1026, 1027, 1028, 1029, 1030, 1031, 1032, 1033, 1035, 1036, 1037, 1038, 1039, 1041, 1042, 1044, 1045, 1046, 1047, 1048, 1055, 1056, 1057, 1058, 1059, 1060, 1061, 1062, 1069, 1070, 1077, 1078, 1079, 1081, 1149, 1150, 1151, 1152, 1153, 1154, 1155, 1157, 1158, 1159, 1160, 1162, 1163, 1164, 1219, 1220, 1221, 1222, 1234, 1235, 1236, 1238, 1254, 1255, 1257, 1312, 1313, 1314, 1324, 1347, 1357, 1358, 1369, 1370, 1371, 1372, 1373, 1374, 1375, 1376, 1377, 1378, 1379, 1380, 1395, 1396, 1398, 1399, 1400, 1430, 1431, 1432, 1433, 1446, 1447, 1448, 1452, 1475, 1476, 1493, 1515, 1516, 1521, 1522, 1523, 1527, 1528, 1529, 1563, 1602, 1606, 1610, 1621, 1622, 1624, 1625, 1626, 1627, 1628, 1629, 1630, 1631, 1684, 1685, 1686, 1688, 1690, 1691, 1692, 1699, 1700, 1704, 1705, 1706, 1707, 1727, 1728, 1747, 1748, 1749, 1750, 1751, 1755, 1756, 1757, 1758, 1787, 1788, 1789, 1802, 16, 29, 47, 48, 49, 63, 252, 253, 254, 255, 256, 257, 282, 310, 311, 312, 324, 338, 341, 359, 362, 374, 375, 376, 380, 381, 383, 391, 392, 393, 394, 395, 398, 399, 400, 402, 404, 405, 408, 411, 418, 419, 421, 436, 437, 439, 441, 442, 444, 445, 448, 515, 550, 683, 727, 729, 739, 753, 754, 755, 756, 757, 758, 759, 760, 761, 762, 763, 764, 765, 766, 767, 768, 769, 770, 771, 772, 773, 774, 775, 778, 779, 780, 781, 782, 783, 784, 785, 786, 787, 788, 789, 790, 791, 792, 793, 794, 795, 796, 797, 798, 799, 800, 801, 814, 817, 839, 840, 848, 877, 888, 889, 920, 929, 943, 988, 989, 990, 991, 992, 993, 1005, 1011, 1012, 1043, 1049, 1050, 1051, 1052, 1053, 1054, 1080, 1111, 1112, 1237, 1310, 1311, 1402, 1453, 1580, 1583, 1584, 1585, 1586, 1587, 1588, 1589, 1701, 1702, 1703)
ORDER BY c.codpsi,
         c.idCom;